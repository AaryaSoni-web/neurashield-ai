name: Reusable NeuraShield Analysis

on:
  workflow_call:
    inputs:
      source-repo:
        description: 'Source repository (owner/repo)'
        required: true
        type: string
      pr-number:
        description: 'Pull request number'
        required: false
        type: number
      issue-number:
        description: 'Issue number'
        required: false
        type: number
    secrets:
      OPENAI_API_KEY:
        description: 'OpenAI API Key for analysis'
        required: true

jobs:
  analyze:
    name: Analyze Code
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      issues: write
      pull-requests: write
    
    steps:
      - name: Checkout NeuraShield AI
        uses: actions/checkout@v4
        with:
          repository: AaryaSoni-web/neurashield-ai
          path: neurashield-ai
      
      - name: Checkout Source Repository
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.source-repo }}
          path: source-code
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install Dependencies
        working-directory: neurashield-ai
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run NeuraShield Analysis
        working-directory: neurashield-ai
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python src/main.py \
            --source-path ../source-code \
            --output ../neurashield-report.json
      
      - name: Save Analysis Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: neurashield-report
          path: neurashield-report.json
          retention-days: 30
      
      - name: Post Analysis Comment
        uses: actions/github-script@v7
        if: always() && (inputs.pr-number || inputs.issue-number)
        continue-on-error: true
        with:
          script: |
            const fs = require('fs');
            let reportBody = '‚ö†Ô∏è Analysis completed. Check workflow logs for details.';
            let commentDetails = '';
            
            try {
              if (fs.existsSync('neurashield-report.json')) {
                const report = JSON.parse(fs.readFileSync('neurashield-report.json', 'utf8'));
                reportBody = report.summary || 'Analysis completed';
                
                if (report.statistics) {
                  const stats = report.statistics;
                  const criticalCount = stats.issues?.critical || 0;
                  const highCount = stats.issues?.high || 0;
                  const mediumCount = stats.issues?.medium || 0;
                  const filesAnalyzed = stats.files_analyzed || 0;
                  const totalLines = stats.total_lines || 0;
                  const securityScore = stats.security_score || 0;
                  
                  commentDetails = '\n\n### üìä Analysis Summary\n';
                  commentDetails += `- **Files Analyzed:** ${filesAnalyzed}\n`;
                  commentDetails += `- **Total Lines:** ${totalLines}\n`;
                  commentDetails += `- **Security Score:** ${securityScore}/100\n`;
                  commentDetails += '\n### ‚ö†Ô∏è Issues Found\n';
                  commentDetails += `- üî¥ Critical: ${criticalCount}\n`;
                  commentDetails += `- üü† High: ${highCount}\n`;
                  commentDetails += `- üü° Medium: ${mediumCount}\n`;
                  
                  if (report.recommendations && report.recommendations.length > 0) {
                    commentDetails += '\n### üìã Recommendations\n';
                    report.recommendations.forEach(rec => {
                      commentDetails += `- ${rec}\n`;
                    });
                  }
                }
                console.log('‚úÖ Report file loaded');
              } else {
                console.log('‚ö†Ô∏è Report file not found');
              }
            } catch (error) {
              console.error('Error reading report:', error.message);
            }
            
            const issueNumber = ${{ inputs.pr-number || inputs.issue-number || 'null' }};
            
            if (!issueNumber) {
              console.log('No issue/PR number, skipping comment');
              return;
            }
            
            try {
              const finalBody = `## üõ°Ô∏è NeuraShield AI Analysis\n\n${reportBody}${commentDetails}\n\n---\n*Powered by [NeuraShield AI](https://github.com/AaryaSoni-web/neurashield-ai)*`;
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: finalBody
              });
              console.log('‚úÖ Comment posted');
            } catch (error) {
              console.error('Failed to post comment:', error.message);
            }
